<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Admin Dashboard + Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        @keyframes shine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .ai-button { background: linear-gradient(90deg, #4f46e5, #9333ea, #4f46e5); background-size: 200% 200%; animation: shine 3s ease infinite; }
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 300ms ease-in-out; }
        .toast-exit { transform: translateX(0); opacity: 1; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 300ms ease-in-out; }
        
        /* Mobile Sidebar Transition */
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }
        @media (min-width: 768px) { .sidebar-closed { transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;

        // ---------------------------------------------------------
        // ğŸ”‘ [ì„¤ì •] API í‚¤ ì ìš© ì™„ë£Œ
        // ---------------------------------------------------------
        const DEFAULT_GEMINI_API_KEY = "AIzaSyCQRoBIeZQWSYPKZe5lTv6JZ73yco-wFgI"; 
        const DEFAULT_GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvf0C_LDJVF04prdqfZABIhXDIVLOUoh-nPjwiUa4OMDOz7-jeBRlTwwbpIXM_zhTyJg/exec";

        const firebaseConfig = {
            apiKey: "AIzaSyDsuxadED3xkBeGf2X2caD2ZWXG0qaSVqc",
            authDomain: "movie-45532.firebaseapp.com",
            projectId: "movie-45532",
            storageBucket: "movie-45532.firebasestorage.app",
            messagingSenderId: "734371910812",
            appId: "1:734371910812:web:b2bad9c351529dbf054959",
            measurementId: "G-S3XL65W4G0"
        };

        let auth = null;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "ì—¬ê¸°ì—_API_KEYë¥¼_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”") {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        const callGemini = async (prompt, apiKey) => {
            if (!apiKey) return { error: "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." };
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) { const errData = await response.json(); throw new Error(errData.error?.message || `API Error: ${response.status}`); }
                const result = await response.json();
                return { text: result.candidates?.[0]?.content?.parts?.[0]?.text };
            } catch (e) { return { error: e.message }; }
        };

        const Icon = ({ name, size = 16, className, ...props }) => {
            if (typeof lucide === 'undefined' || !lucide.icons[name]) return null;
            const [tag, attrs, children] = lucide.icons[name];
            return React.createElement('svg', { ...attrs, width: size, height: size, className: `lucide lucide-${name.toLowerCase()} ${className || ''}`, ...props }, 
                children.map(([t, a], i) => React.createElement(t, { key: i, ...a })));
        };

        const getToday = () => new Date().toISOString().split('T')[0];
        const addDays = (dateStr, days) => { if(!dateStr) return ''; const date = new Date(dateStr); date.setDate(date.getDate() + days); return date.toISOString().split('T')[0]; };
        const addMonths = (dateStr, months) => { if(!dateStr) return ''; const date = new Date(dateStr); date.setMonth(date.getMonth() + months); return date.toISOString().split('T')[0]; };
        const getNextTueOrFri = (dateStr) => { if(!dateStr) return ''; const date = new Date(dateStr); let day = date.getDay(); let add = 0; if (day === 2 || day === 5) return dateStr; if (day < 2) add = 2 - day; else if (day < 5) add = 5 - day; else add = (2 + 7) - day; date.setDate(date.getDate() + add); return date.toISOString().split('T')[0]; };
        const getDuration = (start, end) => { if (!start || !end || end.startsWith('9999')) return ''; const s = new Date(start); const e = new Date(end); const diffTime = Math.abs(e - s); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); return `(${diffDays + 1}ì¼)`; };

        const AdvancedAdminDashboard = () => {
            const [user, setUser] = useState(null); 
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loginEmail, setLoginEmail] = useState("");
            const [loginPw, setLoginPw] = useState("");
            const [loginError, setLoginError] = useState(null);

            // Data States
            const [data, setData] = useState(() => {
                try {
                    const savedData = localStorage.getItem('admin_data_cache');
                    return savedData ? JSON.parse(savedData) : [];
                } catch (e) { return []; }
            });
            const [requests, setRequests] = useState([]);
            const [history, setHistory] = useState([]);
            
            // UI States
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [currentMode, setCurrentMode] = useState('add');
            const [selectedId, setSelectedId] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [pricingTab, setPricingTab] = useState('RENTAL'); 
            const [toastMessage, setToastMessage] = useState(null);
            const [validationError, setValidationError] = useState(null);
            const [isFetching, setIsFetching] = useState(false); 
            const [isSidebarOpen, setIsSidebarOpen] = useState(false); // Mobile Sidebar State

            // Filter & Sort States
            const [managementFilter, setManagementFilter] = useState('ALL'); 
            const [categoryFilter, setCategoryFilter] = useState('ALL'); // New Category Filter
            const [sortConfig, setSortConfig] = useState({ key: 'lastModified', direction: 'desc' }); // Sort Config
            
            const [geminiApiKey, setGeminiApiKey] = useState(() => localStorage.getItem('gemini_api_key') || DEFAULT_GEMINI_API_KEY);
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [currentDate, setCurrentDate] = useState(getToday());

            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 20;

            const CP_LIST = [ "CJ ENM", "ë¡¯ë° ì—”í„°í…Œì¸ë¨¼íŠ¸", "ì‡¼ë°•ìŠ¤", "NEW", "ì½˜í…ì¸ íŒë‹¤", "ì¼€ì´í‹°ì•ŒíŒŒ", "ìŠ¤íŠœë””ì˜¤ì‚°íƒ€í´ë¡œìŠ¤", "ì´ë†€ë¯¸ë””ì–´", "ë‚˜ì¸í”Œë˜ë„ˆìŠ¤", "ì†Œë‹ˆí”½ì³ìŠ¤", "ìœ ë‹ˆë²„ì„¤", "ì›Œë„ˆë¸Œë¼ë”ìŠ¤", "ë””ì¦ˆë‹ˆ", "íŒŒë¼ë§ˆìš´íŠ¸", "ë”ì¿±ë¶„ë°°", "ì—£ë‚˜ì¸í•„ë¦„", "ì˜í™”ì‚¬ ì§„ì§„", "í‹°ìºìŠ¤íŠ¸" ];
            const CATEGORY_LIST = ["í•œêµ­ì˜í™”", "í•œêµ­ì˜í™”ì• ë‹ˆë©”ì´ì…˜", "í•´ì™¸ì˜í™”", "í•´ì™¸ì˜í™”ì• ë‹ˆë©”ì´ì…˜", "í•œë†í˜‘ì˜í™”"];

            const initialForm = { 
                title: '', cp: '', category: 'í•œêµ­ì˜í™”', 
                rating: '', boxOffice: '', actors: '', awards: '', prodYear: '', 
                btvPlusStatus: 'N', btvPlusAvailableDate: '', btvPlusActualDate: '',
                pricingPolicy: [] 
            };
            const [formData, setFormData] = useState(initialForm);

            useEffect(() => {
                try { localStorage.setItem('admin_data_cache', JSON.stringify(data)); } catch(e) {}
            }, [data]);

            useEffect(() => {
                if (auth) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u);
                        setIsLoggedIn(!!u);
                        if(u && data.length === 0) fetchData(); 
                    });
                    return () => unsubscribe();
                }
            }, []);

            useEffect(() => { setCurrentPage(1); }, [searchTerm, managementFilter, categoryFilter, sortConfig]);
            
            // Ensure API Key is set if empty
            useEffect(() => {
                if (!geminiApiKey && DEFAULT_GEMINI_API_KEY) setGeminiApiKey(DEFAULT_GEMINI_API_KEY);
            }, []);

            const fetchData = async () => {
                if (!googleScriptUrl) return showToast("êµ¬ê¸€ ì‹œíŠ¸ URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");
                setIsFetching(true);
                try {
                    const response = await fetch(googleScriptUrl);
                    const json = await response.json();
                    if (Array.isArray(json)) {
                        setData(json);
                        showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                    } else if (json.error) {
                        if(data.length === 0) showToast('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                    }
                } catch (e) { 
                    if(data.length === 0) showToast('ì—°ë™ ì˜¤ë¥˜ (URL í™•ì¸)'); 
                } finally {
                    setIsFetching(false);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoginError(null);
                if (!auth) return setLoginError("Firebase ì„¤ì • ì˜¤ë¥˜");
                try { await auth.signInWithEmailAndPassword(loginEmail, loginPw); } 
                catch (error) { setLoginError("ë¡œê·¸ì¸ ì‹¤íŒ¨: ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”."); }
            };
            const handleLogout = () => auth ? auth.signOut() : setIsLoggedIn(false);
            
            const handleSaveSettings = () => {
                localStorage.setItem('gemini_api_key', geminiApiKey);
                localStorage.setItem('google_script_url', googleScriptUrl);
                setIsSettingsOpen(false);
                showToast('ì„¤ì • ì €ì¥ë¨');
                fetchData(); 
            };
            const showToast = (msg) => { setToastMessage(msg); setTimeout(() => setToastMessage(null), 3000); };

            const syncToSheet = async (item, action = 'UPDATE') => {
                if (!googleScriptUrl) return;
                try {
                    if (action === 'DELETE') {
                         setData(prev => prev.filter(d => d.id !== item.id));
                    }
                    await fetch(googleScriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...item, syncAction: action }) });
                    showToast(action === 'DELETE' ? 'ì‚­ì œ ìš”ì²­ ì „ì†¡ë¨' : 'ì €ì¥ ìš”ì²­ ì „ì†¡ë¨');
                } catch (e) { showToast('âŒ ì „ì†¡ ì‹¤íŒ¨'); }
            };

            const getCurrentPolicy = useCallback((policies) => {
                if (!policies || !Array.isArray(policies) || policies.length === 0) return null;
                return policies.find(p => {
                    if(!p.startDate || !p.endDate) return false;
                    return currentDate >= p.startDate && currentDate <= p.endDate;
                });
            }, [currentDate]);

            const stats = useMemo(() => {
                if (!Array.isArray(data)) return { total: 0, active: 0, monthly: Array(12).fill(0) };
                const total = data.length;
                const active = data.filter(d => getCurrentPolicy(d.pricingPolicy)).length;
                
                const monthly = Array(12).fill(0);
                data.forEach(d => {
                    if (d.pricingPolicy && Array.isArray(d.pricingPolicy) && d.pricingPolicy.length > 0) {
                        const start = d.pricingPolicy[0].startDate;
                        if (start) {
                            const month = new Date(start).getMonth(); // 0-11
                            if (month >= 0 && month < 12) monthly[month]++;
                        }
                    }
                });

                return { total, active, monthly };
            }, [data, getCurrentPolicy]);

            const activeList = useMemo(() => {
                if (!Array.isArray(data)) return [];
                return data.filter(d => getCurrentPolicy(d.pricingPolicy)).slice(0, 10);
            }, [data, getCurrentPolicy]);

            const checkPolicyOverlap = (policies) => {
                if (!policies || !Array.isArray(policies)) return null;
                for (let i = 0; i < policies.length; i++) {
                    for (let j = i + 1; j < policies.length; j++) {
                        const p1 = policies[i];
                        const p2 = policies[j];
                        if (p1.mode === p2.mode) {
                            if (p1.startDate <= p2.endDate && p1.endDate >= p2.startDate) {
                                return `[${p1.mode === 'RENTAL' ? 'ëŒ€ì—¬' : 'ì†Œì¥'}] ì •ì±… ê°„ ê¸°ê°„ì´ ê²¹ì¹©ë‹ˆë‹¤.`;
                            }
                        }
                    }
                }
                return null;
            };

            const handleSave = () => {
                setValidationError(null);
                if (!formData.title || !formData.cp) return setValidationError('íƒ€ì´í‹€ê³¼ CPì‚¬ëŠ” í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.');
                const overlapMsg = checkPolicyOverlap(formData.pricingPolicy);
                if (overlapMsg) return setValidationError(overlapMsg);

                const now = new Date().toLocaleString();
                let savedItem;
                let actionType = currentMode === 'add' ? 'CREATE' : 'UPDATE';
                
                if (currentMode === 'add') {
